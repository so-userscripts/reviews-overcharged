// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Quality of life improvements for review queues
// @grant           none
// @homepage        https://github.com/userscripters/reviews-overcharged#readme
// @match           https://*.stackexchange.com/review/suggested-edits/*
// @match           https://askubuntu.com/review/suggested-edits/*
// @match           https://es.stackoverflow.com/review/suggested-edits/*
// @match           https://ja.stackoverflow.com/review/suggested-edits/*
// @match           https://mathoverflow.net/review/suggested-edits/*
// @match           https://pt.stackoverflow.com/review/suggested-edits/*
// @match           https://ru.stackoverflow.com/review/suggested-edits/*
// @match           https://serverfault.com/review/suggested-edits/*
// @match           https://stackapps.com/review/suggested-edits/*
// @match           https://stackoverflow.com/review/suggested-edits/*
// @match           https://superuser.com/review/suggested-edits/*
// @name            Reviews Overcharged
// @run-at          document-start
// @source          git+https://github.com/userscripters/reviews-overcharged.git
// @supportURL      https://github.com/userscripters/reviews-overcharged/issues
// @version         1.1.1
// ==/UserScript==
!function r(i,n,a){function o(t,e){if(!n[t]){if(!i[t]){var s="function"==typeof require&&require;if(!e&&s)return s(t,!0);if(c)return c(t,!0);throw(s=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",s}s=n[t]={exports:{}},i[t][0].call(s.exports,function(e){return o(i[t][1][e]||e)},s,s.exports,r,i,n,a)}return n[t].exports}for(var c="function"==typeof require&&require,e=0;e<a.length;e++)o(a[e]);return o}({1:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.selectActions=void 0;r.selectActions=({selectors:e})=>[...document.querySelectorAll(e.title.actions)]},{}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getSuggestionsUserStats=r.getSuggestionsByPost=void 0;const a=e("./config"),c=e("./utils");r.getSuggestionsByPost=async(e,{site:t=a.DEF_SITE,type:r="all"})=>{const o=new URL(`${a.API_BASE}/${a.API_VER}/posts/${e}/suggested-edits`);o.search=new URLSearchParams({site:t}).toString();const s=await fetch(o.toString());if(!s.ok)return[];const i=(await s.json())["items"];r={approved:({approval_date:e})=>!!e,rejected:({rejection_date:e})=>!!e,pending:({approval_date:e,rejection_date:t})=>!e&&!t}[r];return r?i.filter(r):i};r.getSuggestionsUserStats=async(e,t,r={})=>{const o=new URL(`${a.API_BASE}/${a.API_VER}/users/${t}/suggested-edits`),s={site:r.site||a.DEF_SITE};Object.keys(r).length&&({from:r,to:n=new Date}=r,r&&(s.from=(0,c.toApiDate)(r)),n&&(s.to=(0,c.toApiDate)(n))),o.search=new URLSearchParams(s).toString();const i=await fetch(o.toString());if(!i.ok)return[];var n=(await i.json())["items"];return n}},{"./config":5,"./utils":18}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.addAuditNotification=void 0;const n=e("./api");r.addAuditNotification=async({selectors:{content:e}},t)=>{var r="audit_notification";if(document.getElementById(r))return!0;t=(await(0,n.getSuggestionsByPost)(t,{type:"pending"})).length;if(t)return!0;const o=document.querySelector(e.typeHint),s=document.querySelector(e.postSummary);if(!o)return!1;const i=document.createElement("blockquote");return i.id=r,i.classList.add("mb12","fs-headline1"),i.textContent="This is an Audit. Tread carefully",o.after(i),o.remove(),null!==s&&void 0!==s&&s.remove(),!0}},{"./api":2}],4:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.removeExistingSidebars=void 0;const s=e("./utils");r.removeExistingSidebars=e=>{e=e.ids.sidebar.extra;const t=[...document.querySelectorAll(`[id^=${e}]`)];if(t.length<=1)return!0;const r=(0,s.getReviewId)(),o=t.filter(({id:e})=>!e.includes(r));return o.forEach(e=>e.remove()),!0}},{"./utils":18}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.config=r.API_VER=r.DEF_SITE=r.API_BASE=void 0;const o=e("./utils");r.API_BASE="https://api.stackexchange.com",r.DEF_SITE="stackoverflow",r.API_VER=2.2,r.config={page:{suggestionId:(0,o.last)(location.pathname.split("/"))},classes:{grid:{container:"grid",cell:"grid--cell"},visibility:{none:"v-hidden"}},ids:{progress:{span:"progress-ratio"},sidebar:{extra:"extra-info"}},filters:{unsafe:")7tZ5Od"},selectors:{actions:{action:".js-action-radio-parent",disabled:".is-disabled",wrapper:".js-review-actions",sidebar:".js-actions-sidebar",modal:{form:"form[action='/suggested-edits/reject']",votes:{labels:"label[for^=rejection-reason].s-label",counts:".s-badge__votes"}},inputs:{reject:"#review-action-Reject"}},buttons:{submit:".js-review-submit",skip:".js-review-actions:not(.d-none) .js-action-button[value=1]",close:".s-modal--close"},reviews:{done:".js-reviews-done",daily:".js-reviews-per-day"},diffs:{deleted:".full-diff .deleted > div",added:".full-diff .inserted > div"},page:{links:{excerpt:"a.question-hyperlink[href*='/tags']",question:"a[href*='/questions/']",answer:"a.answer-hyperlink"}},content:{typeHint:".js-review-content .fs-title",postSummary:".s-post-summary"},title:{description:".s-page-title--description",actions:".s-page-title--actions a",learnMore:".js-show-modal-from-nav.s-link",title:".s-page-title--text",header:".s-page-title--header"},info:{post:{wrapper:".postcell span"},editor:{card:"a.s-user-card--link"}}}}},{"./utils":18}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.decolorDiff=void 0;r.decolorDiff=e=>{var{added:t,deleted:e}=e.selectors.diffs;const r=document.querySelector(t),o=document.querySelector(e);return!(!r||!o)&&(r.style.backgroundColor="unset",o.style.backgroundColor="unset",!0)}},{}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.createItem=r.createGridCell=void 0;const o=e("./config");r.createGridCell=({classes:e})=>{const t=document.createElement("div");return t.classList.add(e.grid.cell),t};r.createItem=(...e)=>{const t=document.createElement("div");return t.classList.add(o.config.classes.grid.cell,"p12"),t.append(...e),t}},{"./config":5}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.waitForSelector=r.goParentUp=r.arraySelect=void 0;r.arraySelect=(e,t)=>[...e.querySelectorAll(t)];r.goParentUp=(e,t=1)=>0!==t&&e?(0,r.goParentUp)(e.parentElement,t-1):e;r.waitForSelector=o=>{var e=document.querySelectorAll(o);return e.length?Promise.resolve(e):new Promise(t=>{const r=new MutationObserver(()=>{var e=document.querySelectorAll(o);e.length&&(r.disconnect(),t(e))});r.observe(document,{subtree:!0,childList:!0,attributes:!0})})}},{}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getSuggestionTotals=r.getEditAuthorId=r.getPostId=r.getEditType=r.getExcerptName=r.getQuestionId=r.getAnswerId=void 0;const s=e("./config"),o=e("./domUtils"),i=e("./utils");r.getAnswerId=async e=>{var[e]=await(0,o.waitForSelector)(e);return(0,i.safeMatch)((null==e?void 0:e.href)||"",/\/questions\/\d+\/[\w-]+\/(\d+)/)[0]};r.getQuestionId=async e=>{var[e]=await(0,o.waitForSelector)(e);return(0,i.safeMatch)((null==e?void 0:e.href)||"",/\/questions\/(\d+)/)[0]};r.getExcerptName=e=>{e=document.querySelector(e);return(0,i.safeMatch)((null==e?void 0:e.href)||"",/\/tags\/(.+)\/info/)[0]};r.getEditType=async({selectors:e})=>{var[{textContent:e}]=await(0,o.waitForSelector)(e.content.typeHint);return(0,i.safeMatch)(e||"",/(question|answer)\s+edit/)[0]};r.getPostId=async e=>{var{links:e}=e["selectors"]["page"];return"question"===await(0,r.getEditType)(s.config)?(0,r.getQuestionId)(e.question):(0,r.getAnswerId)(e.answer)};r.getEditAuthorId=()=>{var e=s.config.selectors.info.post.wrapper,t=document.querySelectorAll(e);if(!t.length)return(0,i.handleMatchFailure)(e,null);e=Array.from(t).find(({textContent:e})=>/proposed/i.test(e||""));if(!e)return null;t=s.config.selectors.info.editor.card;const r=e["parentElement"];e=r.querySelector(t);if(!e)return(0,i.handleMatchFailure)(t,null);const o=e["href"];var[,e]=o.match(/users\/(\d+)/)||[];return e||null};r.getSuggestionTotals=e=>{const r={get ratio(){var{approved:e,pending:t,rejected:r,total:o}=this;return{ofApproved:e/o,ofRejected:r/o,ofPending:t/o,approvedToRejected:e/(0===r?1:r)}},get pending(){var{approved:e,rejected:t,total:r}=this;return r-(e+t)},approved:0,rejected:0,total:0};return e.forEach(({approval_date:e,rejection_date:t})=>{r.total+=1,e&&(r.approved+=1),t&&(r.rejected+=1)}),r}},{"./config":5,"./domUtils":8,"./utils":18}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.isExcerpt=void 0;const o=e("./getters");r.isExcerpt=e=>!!(0,o.getExcerptName)(e.selectors.page.links.excerpt)},{"./getters":9}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const l=e("./audits"),u=e("./cleanup"),p=e("./config"),g=e("./diffs"),f=e("./getters"),m=e("./guards"),v=e("./progress"),h=e("./stats"),y=e("./title");window.addEventListener("load",async()=>{const t=await(0,f.getPostId)(p.config);var e=(0,m.isExcerpt)(p.config);if(t||e){var r={moveProgressToTabs:v.moveProgressToTabs,optimizePageTitle:y.optimizePageTitle,decolorDiff:g.decolorDiff,addStatsSidebar:h.addStatsSidebar};e||Object.assign(r,{addAuditNotification:l.addAuditNotification});const o=Object.values(r),s=[u.removeExistingSidebars],i=Object.keys(r);r=o.map(e=>e(p.config,t));const n=await Promise.all(r);r=n.reduce((e,t,r)=>`${e}
${i[r]} - `+(t?"ok":"failed"),"Status: ");console.debug(r);const{wrapper:a}=p.config["selectors"]["actions"],c=[Node.TEXT_NODE,Node.COMMENT_NODE],d=new MutationObserver(async e=>{e.find(({addedNodes:e})=>[...e].some(t=>c.every(e=>e!==t.nodeType)&&t.matches(a)))&&(await Promise.all([(0,h.addStatsSidebar)(p.config),(0,v.moveProgressToTabs)(p.config)]),await Promise.all(s.map(e=>e(p.config))))});d.observe(document,{subtree:!0,childList:!0})}else console.debug(`ReviewOvercharged init:
Found post id: ${!!t}
Is excerpt: `+e)})},{"./audits":3,"./cleanup":4,"./config":5,"./diffs":6,"./getters":9,"./guards":10,"./progress":12,"./stats":14,"./title":16}],12:[function(e,t,d){"use strict";Object.defineProperty(d,"__esModule",{value:!0}),d.moveProgressToTabs=d.hideProgressBar=void 0;const l=e("./actions"),o=e("./domUtils"),u=e("./utils");d.hideProgressBar=({classes:{visibility:e}},t)=>{const r=(0,o.goParentUp)(t,3);return!!r&&(r.classList.add(e.none),!0)};d.moveProgressToTabs=e=>{var{ids:{progress:{span:t}},selectors:{reviews:r}}=e;const o=(0,l.selectActions)(e);var s=o.find(({href:e})=>/\/review\/suggested-edits/.test(e)),i=document.querySelector(r.daily),n=document.querySelector(r.done);if(!i||!n)return!1;var a=+(0,u.trimNumericString)(i.textContent||"0"),r=+(0,u.trimNumericString)(n.textContent||"0"),n=r/a,n=(0,u.toPercent)(n);if(!s)return!1;const c=s["style"];c.background=`linear-gradient(90deg, var(--theme-primary-color) ${n}, var(--black-075) ${n})`,c.color="var(--black-600)";s=document.getElementById(t)||(({ids:{progress:e}},t)=>{const r=document.createElement("span");return r.id=e.span,t.append(r),r})(e,s);return s.innerHTML=`&nbsp;(${r}/${a})`,(0,d.hideProgressBar)(e,i)}},{"./actions":1,"./domUtils":8,"./utils":18}],13:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getRejectionCount=void 0;const d=e("./domUtils"),l=e("./utils");r.getRejectionCount=async e=>{var{modal:t}=e["selectors"]["actions"],e=await(async e=>{var{buttons:t,actions:{inputs:r,modal:o,action:s,disabled:e}}=e["selectors"];const i=document.querySelector(r.reject),n=document.querySelector(t.submit);if(!i||!n)return null;await(0,d.waitForSelector)(s+`:not(${e})`),i.click(),n.click();const a=[...await(0,d.waitForSelector)(o.form)][0];if(!a)return(0,l.handleMatchFailure)(o.form,null);o=a.cloneNode(!0);const c=a.querySelector(t.close);return c.click(),o})(e);if(!e)return(0,l.handleMatchFailure)(t.form,null);const r=(0,d.arraySelect)(e,t.votes.labels),o={vandalism:0,improvement:0,intent:0,reply:0,harm:0,guidance:0,copyright:0,circular:0},s={102:"improvement",101:"vandalism",104:"intent",105:"reply",106:"copyright",107:"guidance",110:"circular",0:"harm"},i=t.votes.counts;return r.forEach(e=>{const t=e["htmlFor"];var[,r]=t.match(/(\d+$)/)||[],r=s[r];e.querySelector(i)&&(o[r]+=1)}),o}},{"./domUtils":8,"./utils":18}],14:[function(e,t,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c.addStatsSidebar=c.createRejectionCountItem=c.createEditorStatsItem=c.createEditAuthorItem=void 0;const d=e("./api"),p=e("./dom"),g=e("./getters"),l=e("./rejections"),f=e("./templaters"),u=e("./users"),m=e("./utils");c.createEditAuthorItem=({display_name:e,reputation:t,link:r})=>{const o=(0,f.p)("Name: ");return o.append((0,f.a)(r,e)),(0,p.createItem)((0,f.ul)({header:"Edit Author",items:[o,"Reputation: "+t]}))};c.createEditorStatsItem=({link:e},t)=>{const{approved:r,pending:o,rejected:s,total:i,ratio:{approvedToRejected:n,ofApproved:a,ofPending:c,ofRejected:d}}=(0,g.getSuggestionTotals)(t),l={header:"Author Stats",items:[]};if(i)return l.items.push(`Approved: ${r} (${(0,m.toPercent)(a)})`,`Rejected: ${s} (${(0,m.toPercent)(d)})`,`Pending: ${o} (${(0,m.toPercent)(c)})`,"Of total: "+i,"Ratio: "+n.toFixed(1)),(0,p.createItem)((0,f.ul)(l));{const u=(0,f.p)("Tag wiki/excerpt edits are not returned.");return u.append((0,f.br)(),(0,f.text)("See their "),(0,f.a)(e+"?tab=activity&sort=suggestions","activity tab")),l.items.push(u),(0,p.createItem)((0,f.ul)(l))}};c.createRejectionCountItem=e=>{const t=Object.entries(e).filter(([,e])=>!!e),r=t.map(([e,t])=>(0,m.scase)(e)+": "+t);return r.length||r.push("No reject votes"),(0,p.createItem)((0,f.ul)({items:r,header:"Reject votes"}))};c.addStatsSidebar=async e=>{const t=document.querySelector(e.selectors.actions.sidebar);if(!t)return!1;const r=document.createElement("div");r.classList.add("s-sidebarwidget","ps-sticky","t64","ml24","mt24","ws3"),r.id=e.ids.sidebar.extra+"-"+(0,m.getReviewId)();const o=document.createElement("div");o.classList.add("s-sidebarwidget--header"),o.textContent="Extra Info";const s=document.createElement("div");s.classList.add(e.classes.grid.container,"fd-column");var i=(0,g.getEditAuthorId)(),n=await(0,l.getRejectionCount)(e);if(!n)return!1;const a=[];return i&&([e,i]=await Promise.all([(0,u.getUserInfo)(e,i),(0,d.getSuggestionsUserStats)(e,i)]),e&&a.push((0,c.createEditAuthorItem)(e),(0,c.createEditorStatsItem)(e,i))),a.push((0,c.createRejectionCountItem)(n)),s.append(...a),r.append(o,s),t.append(r),!0}},{"./api":2,"./dom":7,"./getters":9,"./rejections":13,"./templaters":15,"./users":17,"./utils":18}],15:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ul=i.text=i.p=i.li=i.br=i.a=void 0;i.a=(e,t=e)=>{const r=document.createElement("a");return r.href=e,r.textContent=t,r.target="_blank",r.referrerPolicy="no-referrer",r};i.br=()=>document.createElement("br");i.li=e=>{const t=document.createElement("li");return"string"==typeof e?t.textContent=e:t.append(e),t};i.p=e=>{const t=document.createElement("p");return t.style.marginBottom="0",t.innerText=e,t};i.text=e=>document.createTextNode(e);i.ul=({header:e,items:t})=>{const r=document.createElement("ul"),o=r["style"];if(o.listStyle="none",o.margin="0",e){const s=document.createElement("h3");s.classList.add("mb8"),s.textContent=e,r.append(s)}t=t.map(i.li);return r.append(...t),r}},{}],16:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.optimizePageTitle=i.removeTitleLines=void 0;const n=e("./dom"),a=e("./utils");i.removeTitleLines=(e,t)=>(t||document).querySelectorAll(e.selectors.title.description).forEach(e=>e.remove());i.optimizePageTitle=e=>{var t=e.selectors.title.title;const r=document.querySelector(t);if(!r)return(0,a.handleMatchFailure)(t,!1);r.classList.add(e.classes.grid.container);t=document.querySelector(e.selectors.title.header);const o=(0,n.createGridCell)(e);o.classList.add("ml12"),t&&o.append(t);t=r.querySelector(e.selectors.title.learnMore);const s=o.cloneNode();return t&&s.append(t),(0,i.removeTitleLines)(e,r),r.append(o,s),!0}},{"./dom":7,"./utils":18}],17:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getUserInfo=void 0;const i=e("./config");r.getUserInfo=async({filters:{unsafe:e}},t,r=i.DEF_SITE)=>{const o=new URL(`${i.API_BASE}/${i.API_VER}/users/`+t);o.search=new URLSearchParams({site:r,filter:e}).toString();const s=await fetch(o.toString());if(!s.ok)return null;var[e]=(await s.json())["items"];return e}},{"./config":5}],18:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getReviewId=r.trimNumericString=r.toPercent=r.toApiDate=r.scase=r.safeMatch=r.last=r.handleMatchFailure=void 0;r.handleMatchFailure=(e,t)=>(console.debug("Couldn't find the element with selector: "+e),t);r.last=e=>e[e.length-1];r.safeMatch=(e,t,r="")=>(e.match(t)||[e,r]).slice(1);r.scase=e=>e[0].toUpperCase()+e.slice(1).toLowerCase();r.toApiDate=e=>(e.valueOf()/1e3).toString();r.toPercent=e=>Math.trunc(100*e)+"%";r.trimNumericString=e=>e.replace(/\D/g,"");r.getReviewId=()=>(0,r.last)(location.href.split("/"))},{}]},{},[11]);